Prefix Search Ranking - Version 2
# Тестовое задание “Prefix Search Ranking” - Реализация на OpenSearch (v2)

Это решение реализует префиксный поиск с использованием OpenSearch для достижения высокого покрытия релевантных запросов без использования хардкода.

## Особенности

*   **Современный поисковый движок:** Использует OpenSearch (форк Elasticsearch с открытым исходным кодом) для надёжных возможностей поиска.
*   **Префиксный поиск:** Настроен с анализаторами `ngram` для эффективного сопоставления префиксов.
*   **Нечёткий поиск:** Использует `fuzziness` в запросах для обработки опечаток и небольших описок.
*   **Query Rewriting:** Реализована логика переписывания запросов для исправления опечаток (например, `xfq` -> `чай`) и транслитерации (например, `холс` -> `hols`) с помощью правил в `corrections.py`.
*   **Упаковка в Docker:** Легко разворачивается с помощью Docker Compose.
*   **Высокое покрытие:** Достигает **76.67%** покрытия релевантных `open` запросов (превышает требование 70%).

## Архитектура

*   **OpenSearch:** Выступает в качестве поискового бэкенда, хранит данные о товарах и обеспечивает функциональность поиска.
*   **Python-скрипты:**
    *   `setup_elasticsearch.py`: Создаёт индекс в OpenSearch и загружает данные о товарах из `data/catalog_products.xml`.
    *   `search_engine.py`: Выполняет запросы к OpenSearch для каждого префикса в `data/prefix_queries.csv`, применяя `Query Rewriting`, и сохраняет результаты в `reports/elasticsearch_evaluation_results_v2.csv`.
    *   `evaluate_coverage.py`: Рассчитывает процент релевантных `open` запросов на основе сгенерированных результатов.
*   **Docker Compose:** Оркестрирует развертывание сервисов OpenSearch и OpenSearch Dashboards.
*   **Dockerfile:** Упаковывает логику Python-приложения в Docker-образ.

## Требования

*   Docker
*   Docker Compose

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <your-repo-url>
    cd <your-repo-directory>
    ```

2.  **Запустите OpenSearch:**
    *   Убедитесь, что ваш `docker-compose.yml` (находится в корне репозитория) настроен правильно (например, `plugins.security.disabled=true`).
    *   Выполните следующую команду из корня репозитория, чтобы запустить OpenSearch и OpenSearch Dashboards:
        ```bash
        docker compose up -d
        ```
    *   Дождитесь, пока контейнер OpenSearch станет `healthy` (проверьте `docker compose ps`).

3.  **Загрузка данных и запуск оценки (Способ 1 - Прямое выполнение Python):**
    *   Активируйте ваше виртуальное окружение Python (если оно у вас есть, хотя строго не требуется для способа с Docker ниже).
    *   Запустите скрипт настройки для загрузки данных:
        ```bash
        python setup_elasticsearch.py
        ```
    *   Запустите скрипт поиска и оценки:
        ```bash
        python search_engine.py
        ```
    *   Результаты будут сохранены в `reports/elasticsearch_evaluation_results_v2.csv`.

4.  **Загрузка данных и запуск оценки (Способ 2 - Использование Dockerfile):**
    *   **Сборка Docker-образа Python-приложения:**
        ```bash
        docker build -t prefix-search-python .
        ```
    *   **Запуск контейнера Python-приложения:**
        *   Этот контейнер выполнит `setup_elasticsearch.py` и `search_engine.py` последовательно.
        *   Он должен иметь возможность достучаться до контейнера OpenSearch. Если OpenSearch запущен в том же `docker-compose` окружении, возможно, нужно запускать Python-контейнер в той же сети или обеспечить сетевую связность. Простой способ - запустить его после `docker compose up -d`, когда OpenSearch подтвержден как запущенный.
        *   Выполните следующую команду из корня репозитория:
            ```bash
            docker run --rm -v $(pwd)/reports:/app/reports prefix-search-python
            ```
        *   Эта команда запускает контейнер, монтирует локальную директорию `reports` в `/app/reports` внутри контейнера (чтобы результаты сохранились на хост-машине) и удаляет контейнер после выполнения.

5.  **Оценка покрытия:**
    *   После запуска `search_engine.py` можно рассчитать покрытие с помощью предоставленного скрипта:
        ```bash
        python evaluate_coverage.py
        ```
        Этот скрипт читает `reports/elasticsearch_evaluation_results_v2.csv` и выводит процент покрытия для `open` запросов.

## Результаты

*   **Покрытие:** Решение достигло **76.67%** покрытия релевантных `open` запросов, превысив порог 70%.
*   **Выходной файл:** Детальные результаты хранятся в `reports/elasticsearch_evaluation_results_v2.csv`.

## Возможные улучшения

*   **Семантический поиск:** Интеграция векторного поиска (эмбеддинги) для улучшения релевантности запросов с синонимами или связанными понятиями (например, "сыр моцарелла" находит "итальянский сыр").
*   **Интеграция LLM:** Использование LLM для переписывания запросов (например, обработка транслитерации вроде "xfq" -> "чай") или для более сложного ранжирования релевантности результатов.
*   **Улучшенная нечёткость:** Тонкая настройка параметров `fuzziness` и настроек `ngram` на основе конкретных паттернов ошибок, наблюдаемых в запросах.
*   **Производительность:** Оптимизация маппингов и запросов OpenSearch для более быстрого времени отклика, особенно под нагрузкой.

## Файлы

*   `docker-compose.yml`: Конфигурация для запуска OpenSearch и OpenSearch Dashboards.
*   `Dockerfile`: Конфигурация для сборки образа Python-приложения.
*   `setup_elasticsearch.py`: Скрипт для создания индекса и загрузки данных в OpenSearch.
*   `search_engine.py`: Скрипт для выполнения поиска и генерации отчёта об оценке.
*   `evaluate_coverage.py`: Скрипт для расчёта процента покрытия из отчёта.
*   `corrections.py`: Скрипт с правилами для Query Rewriting.
*   `data/`: Директория, содержащая входные файлы каталога и запросов.
*   `reports/`: Директория, в которую сохраняется выходной отчёт (`elasticsearch_evaluation_results_v2.csv`).